<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SGS - Ficha de Pre-Ingreso de Aire</title>

    <!-- Dependencias UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
    
    <!-- jsPDF para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Montserrat','Helvetica Neue',Arial,sans-serif;
            background: #ebe7e0;
            overflow-x: hidden
        }

        .wrapper {
            display: flex;
            width: 100%;
            min-height: 100vh
        }

        /* Sidebar */
        .sidebar {
            width: 220px;
            background: #66615b;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            transition: .3s;
            overflow-y: auto
        }

            .sidebar .logo {
                padding: 20px;
                text-align: center;
                border-bottom: 1px solid rgba(255,255,255,.2)
            }

                .sidebar .logo h2 {
                    color: #9e9e9e;
                    margin: 0;
                    font-size: 32px;
                    font-weight: 300
                }

            .sidebar .user {
                padding: 15px 20px;
                border-bottom: 1px solid rgba(255,255,255,.2);
                color: #fff;
                display: flex;
                align-items: center;
                gap: 10px
            }

                .sidebar .user i {
                    font-size: 24px
                }

            .sidebar .nav {
                margin-top: 15px;
                padding: 0;
                list-style: none
            }

                .sidebar .nav li a {
                    color: rgba(255,255,255,.8);
                    padding: 12px 20px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    text-decoration: none;
                    transition: .3s;
                    cursor: pointer
                }

                    .sidebar .nav li a:hover {
                        background: rgba(255,255,255,.1)
                    }

                .sidebar .nav li.active a {
                    color: #51cbce;
                    background: rgba(255,255,255,.1)
                }

        /* Main */
        .main-panel {
            flex: 1;
            margin-left: 220px;
            width: calc(100% - 220px);
            min-height: 100vh;
            display: flex;
            flex-direction: column
        }

        /* Navbar */
        .navbar {
            background: #fff;
            margin: 0;
            padding: 15px 20px;
            box-shadow: 0 1px 4px rgba(0,0,0,.1);
            display: flex;
            align-items: center;
            gap: 15px
        }

            .navbar .btn-menu {
                background: #ef8157;
                color: #fff;
                border: none;
                width: 40px;
                height: 40px;
                display: none;
                align-items: center;
                justify-content: center;
                border-radius: 4px;
                cursor: pointer;
                font-size: 18px
            }

            .navbar h5 {
                margin: 0;
                color: #66615b;
                font-size: 18px;
                font-weight: 400;
                font-family: Muli,Arial,sans-serif
            }

            .navbar .btn-back {
                background: #ef8157;
                color: #fff;
                border: none;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 8px;
                cursor: pointer;
                font-size: 18px
            }

                .navbar .btn-back:hover {
                    opacity: .9
                }

        /* Content & cards */
        .content {
            flex: 1;
            padding: 20px
        }

        .card {
            background: #fff;
            border-radius: 6px;
            box-shadow: 0 6px 10px -4px rgba(0,0,0,.15);
            margin-bottom: 20px
        }

        .card-content {
            padding: 20px
        }

            .card-content label {
                font-family: Muli,Arial,sans-serif;
                font-size: 14px;
                color: #252422;
                font-weight: normal;
                margin-bottom: 5px;
                display: block
            }

        /* Inputs */
        .form-control {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 14px;
            background: #ebe7e0;
            width: 100%
        }

            .form-control:focus {
                outline: none;
                border-color: #51cbce;
                background: #ebe7e0
            }

        /* Botones */
        .btn-enviar {
            background: #5fb3b3;
            color: #fff;
            border: none;
            padding: 10px 30px;
            border-radius: 20px;
            display: block;
            margin: 20px auto;
            cursor: pointer;
            font-size: 14px
        }

            .btn-enviar:hover {
                background: #4fa0a0
            }

        .btn-buscar-puntos {
            background: #ef8157;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px
        }

            .btn-buscar-puntos:hover {
                background: #e96342
            }

        .btn-eliminar {
            background: #e74c3c;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px
        }

            .btn-eliminar:hover {
                background: #c0392b
            }

        .btn-volver {
            background: #66615b;
            color: #fff;
            border: none;
            padding: 10px 30px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin: 20px auto;
            display: block
        }

            .btn-volver:hover {
                background: #57534e
            }

        /* Texto */
        h1 {
            color: #66615b;
            font-size: 24px;
            margin-bottom: 20px
        }
        /* h5 global no se toca; sólo el de navbar arriba */

        /* Dropdown plan */
        .dropdown-custom {
            position: relative
        }

        .dropdown-toggle {
            background: #5fb3b3;
            color: #fff;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-family: Muli,Arial,sans-serif;
            border: none;
            width: 100%;
            text-align: left
        }

        .dropdown-menu-custom {
            display: none;
            position: absolute;
            top: 50px;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,.1)
        }

            .dropdown-menu-custom.show {
                display: block
            }

        .dropdown-item-custom {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0
        }

            .dropdown-item-custom:hover {
                background: #f9f9f9
            }

        .search-input {
            width: calc(100% - 20px);
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px
        }

        /* Tabla principal */
        .table {
            margin-top: 20px;
            width: 100%
        }

            .table thead th {
                border-bottom: 2px solid #ddd;
                color: #252422;
                font-weight: 500;
                font-size: 11px;
                text-transform: uppercase;
                padding: 12px 8px;
                font-family: Muli,Arial,sans-serif
            }

            .table tbody td {
                border-bottom: 1px solid #f0f0f0;
                font-size: 14px;
                padding: 12px 8px;
                font-family: Muli,Arial,sans-serif;
                color: #252422;
                text-align: center
            }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

            .modal.show {
                display: flex;
                align-items: center;
                justify-content: center;
            }

        .modal-content {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ef8157;
            background: transparent;
            color: #ef8157;
        }

            .modal-header h5 {
                font-size: 16px;
                margin: 0;
                font-weight: 500
            }

        .modal-body {
            padding: 0;
            max-height: none;
            overflow-y: visible;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
            margin-top: 10px
        }

        .modal-search {
            margin-bottom: 10px;
        }

            .modal-search input {
                width: 100%;
                padding: 8px 12px;
                border: 2px solid #d0d0d0;
                border-radius: 8px;
                font-size: 14px;
                transition: border-color .3s;
                background: #fafafa
            }

                .modal-search input:focus {
                    outline: none;
                    border-color: #ef8157;
                    background: #fff
                }

        .modal-table {
            width: 100%;
            margin-bottom: 10px;
        }

            .modal-table thead th {
                background: #f5f5f5;
                border-bottom: 2px solid #ddd;
                color: #252422;
                font-weight: 500;
                font-size: 11px;
                text-transform: uppercase;
                padding: 8px 6px;
            }

            .modal-table tbody td {
                border-bottom: 1px solid #f0f0f0;
                font-size: 13px;
                padding: 8px 6px;
            }

            .modal-table tbody tr:hover {
                background: #f9f9f9;
            }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }

            .modal-close:hover {
                color: #ef8157;
            }

        .btn-modal-cancel {
            background: #ccc;
            color: #fff;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-modal-confirm {
            background: #5fb3b3;
            color: #fff;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

            .btn-modal-confirm:hover {
                background: #4fa0a0;
            }

        /* Resumen */
        #resumen {
            display: none
        }

            #resumen.active {
                display: block
            }

        .timeline-badge {
            background: #ef8157;
            color: #fff;
            padding: 8px 20px;
            border-radius: 20px;
            display: inline-block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 20px
        }

        .timeline {
            position: relative;
            padding: 20px 0
        }

            .timeline:before {
                content: '';
                position: absolute;
                left: 30px;
                top: 0;
                bottom: 0;
                width: 2px;
                background: #ddd
            }

        .timeline-item {
            position: relative;
            padding-left: 70px;
            margin-bottom: 30px
        }

        .timeline-icon {
            position: absolute;
            left: 10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 18px;
            z-index: 1
        }

            .timeline-icon.pre-ingreso {
                background: #5fb3b3
            }

            .timeline-icon.recepcion {
                background: #ef8157
            }

        .timeline-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,.1)
        }

        .timeline-card-header {
            font-weight: 600;
            color: #66615b;
            margin-bottom: 10px;
            font-size: 14px
        }

        .timeline-card-body p {
            margin: 5px 0;
            font-size: 13px;
            color: #666
        }

        .link-descarga {
            color: #5fb3b3;
            text-decoration: none;
            font-size: 13px;
            display: inline-block;
            margin-top: 8px
        }

            .link-descarga:hover {
                color: #4fa0a0
            }

        .info-value {
            background: #f5f5f5;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            color: #252422;
            min-height: 38px
        }

        .badge-ingresado {
            background: #27ae60;
            color: #fff;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 12px;
            letter-spacing: .3px
        }

        .resumen-container .card {
            margin-bottom: 16px
        }

        .resumen-header {
            gap: 12px
        }

        /* Responsive */
        @media (max-width:575px) {
            .resumen-header {
                flex-wrap: wrap
            }

                .resumen-header .btn-volver {
                    width: 100%
                }

            .content {
                padding: 12px
            }
        }

        @media (max-width:991px) {
            .sidebar {
                left: -220px
            }

                .sidebar.show {
                    left: 0
                }

            .main-panel {
                margin-left: 0;
                width: 100%
            }

            .navbar .btn-menu {
                display: flex
            }
        }

        .navbar {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #fff;
            padding: 15px 20px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            justify-content: flex-start; /* texto y botones alineados a la izquierda */
        }

            .navbar h5 {
                margin: 0;
                color: #66615b;
                font-size: 18px;
                font-weight: 400;
            }

        .btn-back {
            background: #ef8157;
            color: #fff;
            border: none;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }

            .btn-back:hover {
                opacity: 0.9;
            }

        /* Modal de comentarios */
        .modal-comentario {
            display: none;
            position: fixed;
            z-index: 2001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.5);
            align-items: center;
            justify-content: center
        }

            .modal-comentario.show {
                display: flex
            }

            .modal-comentario .modal-dialog-comment {
                background: #fff;
                border-radius: 8px;
                width: 90%;
                max-width: 600px;
                box-shadow: 0 5px 15px rgba(0,0,0,.3)
            }

            .modal-comentario .modal-header-comment {
                padding: 20px;
                border-bottom: 1px solid #ddd;
                display: flex;
                justify-content: space-between;
                align-items: center
            }

                .modal-comentario .modal-header-comment h5 {
                    margin: 0;
                    color: #66615b;
                    font-size: 18px
                }

                .modal-comentario .modal-header-comment .close-comment {
                    background: none;
                    border: none;
                    font-size: 28px;
                    color: #999;
                    cursor: pointer;
                    line-height: 1;
                    padding: 0;
                    width: 30px;
                    height: 30px
                }

                    .modal-comentario .modal-header-comment .close-comment:hover {
                        color: #333
                    }

            .modal-comentario .modal-body-comment {
                padding: 20px
            }

                .modal-comentario .modal-body-comment label {
                    font-family: Muli,Arial,sans-serif;
                    font-size: 14px;
                    color: #252422;
                    font-weight: normal;
                    margin-bottom: 8px;
                    display: block
                }

                .modal-comentario .modal-body-comment textarea {
                    width: 100%;
                    min-height: 120px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    padding: 10px;
                    font-size: 14px;
                    font-family: 'Montserrat','Helvetica Neue',Arial,sans-serif;
                    resize: vertical
                }

                    .modal-comentario .modal-body-comment textarea:focus {
                        outline: none;
                        border-color: #51cbce
                    }

            .modal-comentario .modal-footer-comment {
                padding: 15px 20px;
                border-top: 1px solid #ddd;
                display: flex;
                justify-content: flex-end;
                gap: 10px
            }

        /* Botón de comentario en la tabla */
        .btn-comentario {
            background: #6c757d;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all .3s;
            margin-right: 5px
        }

            .btn-comentario:hover {
                opacity: .85
            }

            .btn-comentario.has-comment {
                background: #51cbce
            }

            .btn-comentario i {
                font-size: 14px
            }


        /* Botones nuevo punto */
        .modal-search-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 0;
            margin-bottom: 10px
        }

        .modal-search-actions input {
            flex: 1;
            margin: 0;
            padding: 8px 12px;
            border: 2px solid #d0d0d0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color .3s;
            background: #fafafa
        }

            .modal-search-actions input:focus {
                outline: none;
                border-color: #ef8157;
                background: #fff
            }

        .btn-nuevo-punto {
            background: #ef8157;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            transition: all .3s
        }

            .btn-nuevo-punto:hover {
                opacity: .9
            }

        /* Modal agregar punto */
        .modal-agregar-punto {
            display: none;
            position: fixed;
            z-index: 2002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,.5);
            align-items: center;
            justify-content: center
        }

            .modal-agregar-punto.show {
                display: flex
            }

            .modal-agregar-punto .modal-dialog-nuevo {
                background: #fff;
                border-radius: 8px;
                width: 90%;
                max-width: 600px;
                box-shadow: 0 5px 15px rgba(0,0,0,.3)
            }

            .modal-agregar-punto .modal-header-nuevo {
                padding: 20px;
                border-bottom: 1px solid #ddd;
                display: flex;
                justify-content: space-between;
                align-items: center
            }

                .modal-agregar-punto .modal-header-nuevo h5 {
                    margin: 0;
                    color: #66615b;
                    font-size: 18px
                }

                .modal-agregar-punto .modal-header-nuevo .close-nuevo {
                    background: none;
                    border: none;
                    font-size: 28px;
                    color: #999;
                    cursor: pointer;
                    line-height: 1;
                    padding: 0;
                    width: 30px;
                    height: 30px
                }

                    .modal-agregar-punto .modal-header-nuevo .close-nuevo:hover {
                        color: #333
                    }

            .modal-agregar-punto .modal-body-nuevo {
                padding: 20px
            }

                .modal-agregar-punto .modal-body-nuevo .form-group-nuevo {
                    margin-bottom: 15px
                }

                    .modal-agregar-punto .modal-body-nuevo .form-group-nuevo label {
                        font-family: Muli,Arial,sans-serif;
                        font-size: 14px;
                        color: #252422;
                        font-weight: normal;
                        margin-bottom: 5px;
                        display: block
                    }

                        .modal-agregar-punto .modal-body-nuevo .form-group-nuevo label .required {
                            color: #e74c3c
                        }

                    .modal-agregar-punto .modal-body-nuevo .form-group-nuevo input,
                    .modal-agregar-punto .modal-body-nuevo .form-group-nuevo select {
                        width: 100%;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        padding: 10px;
                        font-size: 14px;
                        font-family: 'Montserrat','Helvetica Neue',Arial,sans-serif
                    }

                        .modal-agregar-punto .modal-body-nuevo .form-group-nuevo input:focus,
                        .modal-agregar-punto .modal-body-nuevo .form-group-nuevo select:focus {
                            outline: none;
                            border-color: #51cbce
                        }

            .modal-agregar-punto .modal-footer-nuevo {
                padding: 15px 20px;
                border-top: 1px solid #ddd;
                display: flex;
                justify-content: flex-end;
                gap: 10px
            }


    </style>
</head>

<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar" class="sidebar">
            <div class="logo"><h2>SGS</h2></div>
            <div class="user"><i class="fas fa-user-circle"></i><span>gnunovero</span></div>
            <ul class="nav">
                <li><a href="index.html"><i class="fas fa-home"></i><span>Inicio</span></a></li>
                <li><a href="index.html#ingresos-agua"><i class="fas fa-tint"></i><span>Ingresos de Agua</span></a></li>
                <li class="active"><a href="index.html#ingresos-aire"><i class="fas fa-wind"></i><span>Ingresos de Aire</span></a></li>
                <li><a href="#" id="btnSalir"><i class="fas fa-sign-out-alt"></i><span>Salir</span></a></li>
            </ul>
        </nav>

        <!-- Main -->
        <div class="main-panel">
            <!-- Navbar -->
            <nav class="navbar">
                <button class="btn-menu" id="btnMenu"><i class="fas fa-bars"></i></button>
                <button class="btn-back" id="btnBack" title="Volver"><i class="fas fa-arrow-left"></i></button>
                <h5>Ficha de Pre-Ingreso de Aire</h5>
            </nav>

            <!-- Content -->
            <div class="content" id="pageContent">

                <!-- Información general del cliente -->
                <div class="card">
                    <div class="card-content">
                        <h5>Información general del cliente</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label>Cliente</label>
                                <select class="form-control" id="selectCliente">
                                    <option value="">Seleccione un cliente</option>
                                    <option value="codelco">61704000-K - CORP NACIONAL DEL COBRE DE CHILE</option>
                                    <option value="antofagasta">96.955.310-7 - ANTOFAGASTA MINERALS S.A.</option>
                                    <option value="escondida">79.691.790-6 - MINERA ESCONDIDA LTDA</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>OL</label>
                                <select class="form-control" id="selectOL">
                                    <option value="">Seleccione una OL</option>
                                </select>
                            </div>
                        </div>

                        <div id="infoAdicional" style="display:none">
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label>Proyecto</label>
                                    <select class="form-control" id="selectProyecto">
                                        <option value="">Seleccione un proyecto</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label>Solicitado por:</label>
                                    <input type="text" class="form-control" id="solicitadoPor" value="gnunovero" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label>Atención a:</label>
                                    <input type="text" class="form-control" id="atencionA" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label>ADC Responsable:</label>
                                    <input type="text" class="form-control" id="adcResponsable" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Paso 1 - General -->
                <div class="card">
                    <div class="card-content">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Paso 1 - General</h5>
                            <span style="font-size:14px;color:#666">Fecha: 19/10/2025</span>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label>Tipo Muestreo</label>
                                <div>
                                    <label class="mr-3 d-inline-block"><input type="radio" name="tipoMuestreo" value="mps" checked> MPS</label>
                                    <label class="d-inline-block"><input type="radio" name="tipoMuestreo" value="filtros"> Filtros</label>
                                </div>
                            </div>
                            <div class="col-md-6" id="opcionesFiltros" style="display:none">
                                <label>Tipo de Filtro</label>
                                <div>
                                    <label class="mr-3 d-inline-block"><input type="radio" name="tipoFiltro" value="mp10"> MP10</label>
                                    <label class="d-inline-block"><input type="radio" name="tipoFiltro" value="mp25"> MP2.5</label>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label>Muestreado por:</label>
                                <div>
                                    <label class="mr-3 d-inline-block"><input type="radio" name="muestreadoPor" value="sgs" checked> SGS Chile</label>
                                    <label class="d-inline-block"><input type="radio" name="muestreadoPor" value="cliente"> Cliente</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label>Matriz</label>
                                <select class="form-control" id="matriz">
                                    <option value="">Seleccione Matriz</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <label>Plan</label>
                                <div class="dropdown-custom">
                                    <button class="dropdown-toggle" id="btnPlanesToggle">
                                        <span id="planesText">Seleccione un Plan</span>
                                        <i class="fas fa-chevron-down" style="float:right;margin-top:3px"></i>
                                    </button>
                                    <div id="planesDropdown" class="dropdown-menu-custom">
                                        <input type="text" class="search-input" id="searchPlanes" placeholder="Buscar...">
                                        <div class="dropdown-item-custom" data-plan="AIRE_001_A">AIRE_001_A</div>
                                        <div class="dropdown-item-custom" data-plan="AIRE_002_B">AIRE_002_B</div>
                                        <div class="dropdown-item-custom" data-plan="AIRE_003_C">AIRE_003_C</div>
                                        <div class="dropdown-item-custom" data-plan="AIRE_004_D">AIRE_004_D</div>
                                        <div class="dropdown-item-custom" data-plan="AIRE_005_E">AIRE_005_E</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Paso 2 - Puntos de Muestreo -->
                <div class="card">
                    <div class="card-content">
                        <h5>Paso 2 - Puntos de Muestreo</h5>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <button class="btn-buscar-puntos" id="btnBuscarPuntos">
                                    <i class="fas fa-search"></i> Buscar Puntos de Muestreo
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive mb-3">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width:50px">#</th>
                                        <th>ID MUESTRA</th>
                                        <th>LUGAR DE MUESTREO</th>
                                        <th>FECHA/HORA INICIO</th>
                                        <th>FECHA/HORA TÉRMINO</th>
                                        <th>COMENTARIOS</th>
                                        <th>ACCIÓN</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaPuntosSeleccionados">
                                    <tr><td colspan="7" style="padding:20px;color:#999;text-align:center">No hay puntos seleccionados</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <strong>Cantidad de muestras ingresadas: <span id="contadorMuestras">0</span></strong>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label>Responsable de Muestreo</label>
                                <input type="text" class="form-control" id="responsableMuestreo">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label>Fecha Transporte</label>
                                <input type="date" class="form-control" id="fechaTransporte" value="2025-10-19">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label>Hora Transporte</label>
                                <input type="time" class="form-control" id="horaTransporte" value="21:38">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Observación General</label>
                            <textarea class="form-control" id="observacionesTerreno" rows="3"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Modal de Puntos -->
                <div id="modalPuntos" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalPuntosTitulo">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 id="modalPuntosTitulo">Seleccionar</h5>
                            <button class="modal-close" id="btnCerrarModal" aria-label="Cerrar">&times;</button>
                        </div>
                        <div class="modal-search">
                            <input type="text" id="searchPuntos" placeholder="Buscar...">
                        </div>
                        <div class="modal-body" style="overflow-x:auto">
                            <table class="modal-table">
                                <thead><tr id="modalTableHeader"></tr></thead>
                                <tbody id="tablaPuntosModal"></tbody>
                            </table>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-modal-cancel" id="btnCancelarModal">Cancelar</button>
                            <button class="btn-modal-confirm" id="btnConfirmarSeleccion">Agregar Seleccionados</button>
                        </div>
                    </div>
                </div>

                <!-- Paso 3 - Generación de JOB -->
                <div class="card">
                    <div class="card-content">
                        <h5>Paso 3 - Generación de JOB</h5>
                        <div class="form-group" id="opcionJobTotal" style="display:none">
                            <label><input type="radio" name="job" value="total"> Generar un JOB para la totalidad de los puntos ingresados</label>
                        </div>
                        <div class="form-group" id="opcionJobIndividual">
                            <label><input type="radio" name="job" value="individual" checked> Generar un JOB por punto ingresado</label>
                        </div>
                        <button class="btn-enviar" id="btnEnviar">Enviar Pre-Ingreso</button>
                    </div>
                </div>

            </div><!-- /content -->
        </div><!-- /main-panel -->
    </div><!-- /wrapper -->
    <!-- Script de aplicación -->
    <script>
        // --- Datos base ---
        const clientesData = { codelco: { nombre: 'CORP NACIONAL DEL COBRE DE CHILE', rut: '61704000-K', ols: [{ codigo: '801598', adc: 'kpizarro', atencionA: 'Juan Pérez', proyectos: ['Proyecto Chuquicamata', 'Proyecto Radomiro Tomic', 'Proyecto Ministro Hales'] }, { codigo: '801645', adc: 'mrodriguez', atencionA: 'María González', proyectos: ['Proyecto El Teniente', 'Proyecto Andina'] }] }, antofagasta: { nombre: 'ANTOFAGASTA MINERALS S.A.', rut: '96.955.310-7', ols: [{ codigo: '802105', adc: 'lmartinez', atencionA: 'Ana Rojas', proyectos: ['Proyecto Los Pelambres', 'Proyecto Centinela'] }] }, escondida: { nombre: 'MINERA ESCONDIDA LTDA', rut: '79.691.790-6', ols: [{ codigo: '803421', adc: 'rcastillo', atencionA: 'Luis Torres', proyectos: ['Proyecto Escondida Principal', 'Proyecto Escondida Norte'] }] } };

        const puntosMuestreoPorCliente = { codelco: [{ id: 'MPS-CDL-001', lugar: 'Planta Concentradora', direccion: 'Sector Norte, Chuquicamata', coordenadas: '-22.3095, -68.9029' }, { id: 'MPS-CDL-002', lugar: 'Área de Chancado', direccion: 'Sector Este, Chuquicamata', coordenadas: '-22.3105, -68.9039' }, { id: 'MPS-CDL-003', lugar: 'Depósito de Relaves', direccion: 'Sector Sur, El Teniente', coordenadas: '-34.0895, -70.4512' }], antofagasta: [{ id: 'MPS-ANT-001', lugar: 'Planta de Procesos', direccion: 'Los Pelambres, Salamanca', coordenadas: '-31.7321, -70.5689' }, { id: 'MPS-ANT-002', lugar: 'Tranque de Relaves', direccion: 'Sector El Mauro', coordenadas: '-31.8456, -70.4521' }], escondida: [{ id: 'MPS-ESC-001', lugar: 'Mina Rajo Abierto', direccion: 'Escondida, Antofagasta', coordenadas: '-24.2345, -69.0567' }, { id: 'MPS-ESC-002', lugar: 'Puerto de Embarque', direccion: 'Coloso, Antofagasta', coordenadas: '-23.7521, -70.4456' }] };

        const filtrosPorCliente = { codelco: { mp10: [{ id: 'FLT-MP10-CDL-001', pesoOriginal: '0.5234 g', fechaCreacion: '2025-10-01' }, { id: 'FLT-MP10-CDL-002', pesoOriginal: '0.5198 g', fechaCreacion: '2025-10-02' }, { id: 'FLT-MP10-CDL-003', pesoOriginal: '0.5267 g', fechaCreacion: '2025-09-15' }], mp25: [{ id: 'FLT-MP25-CDL-001', pesoOriginal: '0.4987 g', fechaCreacion: '2025-10-01' }, { id: 'FLT-MP25-CDL-002', pesoOriginal: '0.5012 g', fechaCreacion: '2025-09-20' }] }, antofagasta: { mp10: [{ id: 'FLT-MP10-ANT-001', pesoOriginal: '0.5245 g', fechaCreacion: '2025-10-03' }, { id: 'FLT-MP10-ANT-002', pesoOriginal: '0.5212 g', fechaCreacion: '2025-10-04' }], mp25: [{ id: 'FLT-MP25-ANT-001', pesoOriginal: '0.5023 g', fechaCreacion: '2025-10-03' }] }, escondida: { mp10: [{ id: 'FLT-MP10-ESC-001', pesoOriginal: '0.5234 g', fechaCreacion: '2025-10-02' }, { id: 'FLT-MP10-ESC-002', pesoOriginal: '0.5267 g', fechaCreacion: '2025-09-18' }], mp25: [{ id: 'FLT-MP25-ESC-001', pesoOriginal: '0.5012 g', fechaCreacion: '2025-10-02' }] } };

        // --- Estado ---
        let puntosSeleccionados = []; let clienteActual = '';

        // --- Helpers ---
        const qs = (s, c = document) => c.querySelector(s), qsa = (s, c = document) => Array.from(c.querySelectorAll(s));
        const setVisible = (el, show) => el.style.display = show ? '' : 'none';
        const modal = qs('#modalPuntos');

        // --- Tabla puntos ---
        function actualizarTablaPuntos() {
            const tbody = qs('#tablaPuntosSeleccionados'), contador = qs('#contadorMuestras');
            if (!puntosSeleccionados.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding:20px;color:#999;text-align:center">No hay puntos seleccionados</td></tr>';
                contador.textContent = '0'; return;
            }
            tbody.innerHTML = ''; contador.textContent = String(puntosSeleccionados.length);
            puntosSeleccionados.forEach((p, index) => {
                const tr = document.createElement('tr');
                if (p.tipo === 'filtro') {
                    tr.innerHTML = `<td style="text-align:center;font-weight:bold;">${index + 1}</td>
              <td><div style="font-weight:500;">${p.id}</div>
                  <div style="font-size:11px;color:#666;">Filtro ${p.tipoFiltro.toUpperCase()} - Creado: ${p.fechaCreacion}</div></td>
              <td><input type="text" class="form-control" style="font-size:12px;" value="${p.lugarMuestreo || ''}" data-idx="${index}" data-field="lugarMuestreo" placeholder="Ingrese lugar"></td>
              <td><input type="date" class="form-control" style="display:inline-block;width:48%;margin-right:2%;font-size:12px;" value="${p.fechaInicio || ''}" data-idx="${index}" data-type="filtro" data-field="fechaInicio">
                  <input type="time" class="form-control" style="display:inline-block;width:48%;font-size:12px;" value="${p.horaInicio || ''}" data-idx="${index}" data-type="filtro" data-field="horaInicio"></td>
              <td><input type="date" class="form-control" style="display:inline-block;width:48%;margin-right:2%;font-size:12px;" value="${p.fechaTermino || ''}" data-idx="${index}" data-type="filtro" data-field="fechaTermino">
                  <input type="time" class="form-control" style="display:inline-block;width:48%;font-size:12px;" value="${p.horaTermino || ''}" data-idx="${index}" data-type="filtro" data-field="horaTermino"></td>
              <td style="text-align:center;"><button class="btn-comentario ${p.comentario && p.comentario.trim() ? 'has-comment' : ''}" data-comment-idx="${index}" title="${p.comentario && p.comentario.trim() ? 'Ver/Editar comentario' : 'Agregar comentario'}"><i class="fas ${p.comentario && p.comentario.trim() ? 'fa-comment' : 'fa-comment-dots'}"></i></button></td>
              <td style="text-align:center;"><button class="btn-eliminar" data-remove="${index}"><i class="fas fa-trash"></i></button></td>`;
                } else {
                    tr.innerHTML = `<td style="text-align:center;font-weight:bold;">${index + 1}</td>
              <td>${p.id}</td>
              <td><div style="font-weight:500;">${p.lugar}</div><div style="font-size:11px;color:#666;">${p.direccion}</div></td>
              <td><input type="date" class="form-control" style="display:inline-block;width:48%;margin-right:2%;font-size:12px;" value="${p.fechaInicio || ''}" data-idx="${index}" data-type="mps" data-field="fechaInicio">
                  <input type="time" class="form-control" style="display:inline-block;width:48%;font-size:12px;" value="${p.horaInicio || ''}" data-idx="${index}" data-type="mps" data-field="horaInicio"></td>
              <td><input type="date" class="form-control" style="display:inline-block;width:48%;margin-right:2%;font-size:12px;" value="${p.fechaTermino || ''}" data-idx="${index}" data-type="mps" data-field="fechaTermino">
                  <input type="time" class="form-control" style="display:inline-block;width:48%;font-size:12px;" value="${p.horaTermino || ''}" data-idx="${index}" data-type="mps" data-field="horaTermino"></td>
              <td style="text-align:center;"><button class="btn-comentario ${p.comentario && p.comentario.trim() ? 'has-comment' : ''}" data-comment-idx="${index}" title="${p.comentario && p.comentario.trim() ? 'Ver/Editar comentario' : 'Agregar comentario'}"><i class="fas ${p.comentario && p.comentario.trim() ? 'fa-comment' : 'fa-comment-dots'}"></i></button></td>
              <td style="text-align:center;"><button class="btn-eliminar" data-remove="${index}"><i class="fas fa-trash"></i></button></td>`;
                }
                tbody.appendChild(tr);
            });
        }

        function eliminarPunto(i) { puntosSeleccionados.splice(i, 1); actualizarTablaPuntos() }

        // --- Modales ---
        function abrirModalMPS() {
            const titulo = qs('#modalPuntosTitulo'), tbody = qs('#tablaPuntosModal'), thead = qs('#modalTableHeader'), pts = puntosMuestreoPorCliente[clienteActual] || [];
            titulo.textContent = 'Seleccionar Puntos de Muestreo MPS';
            
            // Agregar botones si no existen
            let searchDiv = qs('.modal-search');
            let actionsDiv = qs('.modal-search-actions');
            
            if (!actionsDiv) {
                // Mover input de búsqueda a nuevo contenedor
                const searchInput = qs('#searchPuntos');
                actionsDiv = document.createElement('div');
                actionsDiv.className = 'modal-search-actions';
                actionsDiv.appendChild(searchInput);
                
                // Agregar botones
                const btnNuevo = document.createElement('button');
                btnNuevo.className = 'btn-nuevo-punto';
                btnNuevo.id = 'btnNuevoPunto';
                btnNuevo.textContent = 'Nuevo Punto';
                
                const btnMasivo = document.createElement('button');
                btnMasivo.className = 'btn-nuevo-punto';
                btnMasivo.id = 'btnMasivo';
                btnMasivo.textContent = 'Masivo';
                
                actionsDiv.appendChild(btnNuevo);
                actionsDiv.appendChild(btnMasivo);
                
                searchDiv.parentNode.insertBefore(actionsDiv, searchDiv);
                searchDiv.style.display = 'none';
            }
            actionsDiv.style.display = 'flex';
            
            thead.innerHTML = '<th style="width:50px"><input type="checkbox" id="selectAll"></th><th>ID MUESTRA</th><th>LUGAR / DIRECCIÓN</th><th>COORDENADAS</th>';
            tbody.innerHTML = '';
            pts.forEach((p, idx) => {
                const ya = puntosSeleccionados.some(x => x.id === p.id);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><input type="checkbox" class="checkbox-punto" data-index="${idx}" data-tipo="mps" ${ya ? 'checked' : ''}></td>
                          <td>${p.id}</td>
                          <td><div><strong>${p.lugar}</strong></div><div style="font-size:11px;color:#666;">${p.direccion}</div></td>
                          <td>${p.coordenadas}</td>`;
                tbody.appendChild(tr);
            });
            modal.classList.add('show');
        }

        function abrirModalFiltros(tipoFiltro) {
            const titulo = qs('#modalPuntosTitulo'), tbody = qs('#tablaPuntosModal'), thead = qs('#modalTableHeader'), arr = (filtrosPorCliente[clienteActual] || {})[tipoFiltro] || [];
            titulo.textContent = `Seleccionar Filtros ${tipoFiltro.toUpperCase()}`;
            
            // Ocultar botones en modo filtros
            const actionsDiv = qs('.modal-search-actions');
            if (actionsDiv) actionsDiv.style.display = 'none';
            qs('.modal-search').style.display = 'block';
            thead.innerHTML = '<th style="width:50px"><input type="checkbox" id="selectAll"></th><th>ID FILTRO</th><th>FECHA CREACIÓN</th><th>ESTADO</th>';
            tbody.innerHTML = '';
            const hoy = new Date();
            arr.forEach((f, idx) => {
                const ya = puntosSeleccionados.some(x => x.id === f.id);
                const d = new Date(f.fechaCreacion), dias = Math.floor((hoy - d) / 86400000);
                let estado = '', ok = true;
                if (dias > 30) { estado = '<span style="color:#e74c3c;font-weight:bold;">⚠ Vida útil excedida</span>'; ok = false }
                else if (dias > 25) { estado = '<span style="color:#f39c12;font-weight:bold;">⚠ Próximo a vencer</span>' }
                else { estado = '<span style="color:#27ae60;">✓ Disponible</span>' }
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><input type="checkbox" class="checkbox-punto" data-index="${idx}" data-tipo="filtro" ${ya ? 'checked' : ''} ${!ok ? 'disabled' : ''}></td>
                          <td>${f.id}</td>
                          <td>${f.fechaCreacion}<br><small style="color:#666;">(${dias} días)</small></td>
                          <td>${estado}</td>`;
                if (!ok) tr.style.opacity = '.5';
                tbody.appendChild(tr);
            });
            modal.classList.add('show');
        }

        function cerrarModalPuntos() { modal.classList.remove('show') }


        // ===== FUNCIONALIDAD DE COMENTARIOS =====
        let comentarioActualIdx = -1;
        let modalComentario;
        let textareaComentario;

        // Abrir modal de comentarios
        function abrirModalComentario(idx) {
            comentarioActualIdx = idx;
            const punto = puntosSeleccionados[idx];
            textareaComentario.value = punto.comentario || '';
            modalComentario.classList.add('show');
            textareaComentario.focus();
        }

        // Cerrar modal de comentarios
        function cerrarModalComentario() {
            modalComentario.classList.remove('show');
            textareaComentario.value = '';
            comentarioActualIdx = -1;
        }

        // Guardar comentario
        function guardarComentario() {
            if (comentarioActualIdx >= 0 && comentarioActualIdx < puntosSeleccionados.length) {
                puntosSeleccionados[comentarioActualIdx].comentario = textareaComentario.value.trim();
                actualizarTablaPuntos();
                cerrarModalComentario();
            }
        }
        // ===== FIN FUNCIONALIDAD DE COMENTARIOS =====


        // ===== FUNCIONALIDAD AGREGAR NUEVO PUNTO MPS =====
        let modalAgregarPunto;

        // Abrir modal agregar punto
        function abrirModalAgregarPunto() {
            // Cargar lugares de monitoreo según cliente
            const selectLugar = qs('#lugarMonitoreoNuevoPunto');
            selectLugar.innerHTML = '<option value="">Seleccione un lugar</option>';
            
            if (clienteActual && clientesData[clienteActual]) {
                const cliente = clientesData[clienteActual];
                
                // Agregar proyectos como lugares
                cliente.ols.forEach(ol => {
                    ol.proyectos.forEach(proyecto => {
                        const option = document.createElement('option');
                        option.value = proyecto;
                        option.textContent = proyecto;
                        selectLugar.appendChild(option);
                    });
                });
            }
            
            // Preseleccionar matriz del paso 1
            const matrizPaso1 = qs('#matriz').value;
            qs('#matrizNuevoPunto').value = matrizPaso1 || '';
            
            // Limpiar campos
            qs('#nombrePuntoNuevo').value = '';
            qs('#direccionMonitoreoNuevo').value = '';
            
            modalAgregarPunto.classList.add('show');
        }

        // Cerrar modal agregar punto
        function cerrarModalAgregarPunto() {
            modalAgregarPunto.classList.remove('show');
        }

        // Guardar nuevo punto
        function guardarNuevoPunto() {
            const matriz = qs('#matrizNuevoPunto').value;
            const lugar = qs('#lugarMonitoreoNuevoPunto').value;
            const nombre = qs('#nombrePuntoNuevo').value.trim();
            const direccion = qs('#direccionMonitoreoNuevo').value.trim();
            
            // Validar campos
            if (!matriz) {
                alert('Por favor, seleccione una matriz');
                return;
            }
            if (!lugar) {
                alert('Por favor, seleccione un lugar de monitoreo');
                return;
            }
            if (!nombre) {
                alert('Por favor, ingrese el nombre del punto');
                return;
            }
            if (!direccion) {
                alert('Por favor, ingrese la dirección de monitoreo');
                return;
            }
            
            // Crear nuevo punto con mapeo correcto
            const nuevoPunto = {
                id: nombre,                    // Nombre del punto → ID Muestra
                lugar: lugar,                  // Lugar de Monitoreo → Lugar en grilla
                direccion: direccion,          // Dirección → Dirección en grilla
                coordenadas: 'N/A',
                tipo: 'mps'
            };
            
            // Agregar a la lista de puntos del cliente
            if (!puntosMuestreoPorCliente[clienteActual]) {
                puntosMuestreoPorCliente[clienteActual] = [];
            }
            puntosMuestreoPorCliente[clienteActual].push(nuevoPunto);
            
            // Cerrar modal
            cerrarModalAgregarPunto();
            
            // Refrescar la lista de puntos en el modal principal
            abrirModalMPS();
            
            // Mostrar mensaje de éxito
            alert('Punto de muestreo agregado exitosamente');
        }
        // ===== FIN FUNCIONALIDAD AGREGAR NUEVO PUNTO =====

        // ===== MODAL MASIVO (SOLO VISUAL) =====
        let modalAgregarMasivo;

        function abrirModalMasivo() {
            // Preseleccionar matriz del paso 1
            const matrizPaso1 = qs('#matriz').value;
            qs('#matrizMasivo').value = matrizPaso1 || '';
            
            // Cargar lugares de monitoreo
            const selectLugar = qs('#lugarMonitoreoMasivo');
            selectLugar.innerHTML = '<option value="">Seleccione un lugar</option>';
            
            if (clienteActual && clientesData[clienteActual]) {
                const cliente = clientesData[clienteActual];
                cliente.ols.forEach(ol => {
                    ol.proyectos.forEach(proyecto => {
                        const option = document.createElement('option');
                        option.value = proyecto;
                        option.textContent = proyecto;
                        selectLugar.appendChild(option);
                    });
                });
            }
            
            // Limpiar textarea
            qs('#dataMasivo').value = '';
            
            modalAgregarMasivo.classList.add('show');
        }

        function cerrarModalMasivo() {
            modalAgregarMasivo.classList.remove('show');
        }
        // ===== FIN MODAL MASIVO =====

        // ===== GENERAR PDF ACTA DE PRE-INGRESO =====
        function generarPDFActa() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Obtener datos guardados
            const folio = sessionStorage.getItem('folioPreIngreso');
            const datosStr = sessionStorage.getItem('datosPreIngreso');
            if (!folio || !datosStr) {
                alert('No hay datos de pre-ingreso para generar el PDF');
                return;
            }
            
            const datos = JSON.parse(datosStr);
            const cliente = clientesData[clienteActual];
            const olSeleccionada = datos.ol.split('-');
            const ol = cliente.ols[parseInt(olSeleccionada[1], 10)];
            
            let y = 20;
            
            // Título
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(`ACTA DE PRE-INGRESO N° ${folio}`, 105, y, { align: 'center' });
            y += 12;
            
            // Información Cliente
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('Información Cliente', 20, y);
            doc.setDrawColor(0);
            doc.setLineWidth(0.5);
            doc.line(20, y + 1, 190, y + 1);
            y += 7;
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('SOLICITANTE', 20, y);
            doc.text(': ' + cliente.nombre, 70, y);
            y += 5;
            doc.text('ADC Responsable', 20, y);
            doc.text(': ' + datos.adcResponsable, 70, y);
            y += 5;
            doc.text('OL', 20, y);
            doc.text(': ' + ol.codigo, 70, y);
            y += 5;
            doc.text('Contacto', 20, y);
            doc.text(': ' + datos.atencionA, 70, y);
            y += 8;
            
            // Información General
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('Información General', 20, y);
            doc.line(20, y + 1, 190, y + 1);
            y += 7;
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('Tipo de muestra', 20, y);
            doc.text(': ' + (datos.tipoMuestreo === 'mps' ? 'MPS' : 'Filtros'), 70, y);
            y += 5;
            doc.text('Origen de las muestras (Matriz)', 20, y);
            doc.text(': ' + datos.matriz, 70, y);
            y += 5;
            doc.text('Muestreados por', 20, y);
            doc.text(': ' + (datos.muestreadoPor === 'sgs' ? 'SGS Chile' : 'CLIENTE'), 70, y);
            y += 5;
            doc.text('Destino de la muestra', 20, y);
            doc.text(': Laboratorio SGS Santiago', 70, y);
            y += 5;
            doc.text('Número de muestras', 20, y);
            doc.text(': ' + datos.puntosSeleccionados.length, 70, y);
            y += 5;
            doc.text('Plan', 20, y);
            doc.text(': ' + datos.plan, 70, y);
            y += 5;
            doc.text('Generación de JOB', 20, y);
            const jobText = datos.generacionJob === 'total' 
                ? 'Generar un JOB para la totalidad de los puntos ingresados' 
                : 'Generar un JOB por punto ingresado';
            doc.text(': ' + jobText, 70, y);
            y += 8;
            
            // Puntos de Monitoreo
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('Puntos de Monitoreo', 20, y);
            doc.line(20, y + 1, 190, y + 1);
            y += 5;
            
            const tablaPuntos = [];
            datos.puntosSeleccionados.forEach((p, idx) => {
                // ID MUESTRA
                let idMuestra = p.id || 'N/A';
                if (p.tipo === 'filtro') {
                    idMuestra += `\nFiltro ${p.tipoFiltro.toUpperCase()} - Creado: ${p.fechaCreacion}`;
                }
                
                // LUGAR DE MUESTREO
                let lugarMuestreo = '';
                if (p.tipo === 'filtro') {
                    lugarMuestreo = p.lugarMuestreo || '';
                } else {
                    lugarMuestreo = p.lugar || 'N/A';
                    if (p.direccion) {
                        lugarMuestreo += `\n${p.direccion}`;
                    }
                }
                
                // FECHA/HORA INICIO
                const fechaInicio = p.fechaInicio && p.horaInicio 
                    ? `${p.fechaInicio} ${p.horaInicio}` 
                    : p.fechaInicio || '';
                
                // FECHA/HORA TÉRMINO
                const fechaTermino = p.fechaTermino && p.horaTermino 
                    ? `${p.fechaTermino} ${p.horaTermino}` 
                    : p.fechaTermino || '';
                
                // COMENTARIOS
                const comentario = p.comentario && p.comentario.trim() 
                    ? p.comentario 
                    : 'Sin comentario';
                
                tablaPuntos.push([
                    idx + 1, 
                    idMuestra, 
                    lugarMuestreo, 
                    fechaInicio, 
                    fechaTermino,
                    comentario
                ]);
            });
            
            doc.autoTable({
                startY: y,
                head: [['#', 'ID MUESTRA', 'LUGAR DE MUESTREO', 'FECHA/HORA INICIO', 'FECHA/HORA TÉRMINO', 'COMENTARIOS']],
                body: tablaPuntos,
                theme: 'grid',
                styles: { 
                    fontSize: 7, 
                    cellPadding: 2,
                    lineColor: [200, 200, 200],
                    lineWidth: 0.1
                },
                headStyles: { 
                    fillColor: [240, 240, 240], 
                    textColor: [0, 0, 0], 
                    fontStyle: 'bold',
                    fontSize: 7
                },
                columnStyles: {
                    0: { cellWidth: 8, halign: 'center' },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 32 },
                    4: { cellWidth: 32 },
                    5: { cellWidth: 38 }
                }
            });
            
            y = doc.lastAutoTable.finalY + 8;
            
            // Información adicional
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text('Fecha de Transporte', 20, y);
            doc.text(': ' + datos.fechaTransporte + ' ' + datos.horaTransporte, 70, y);
            y += 5;
            doc.text('Responsable del monitoreo', 20, y);
            doc.text(': ' + datos.responsable, 70, y);
            y += 5;
            doc.text('Observaciones de Terreno', 20, y);
            doc.text(': ' + datos.observaciones, 70, y);
            y += 15;
            
            // Footer
            doc.setFontSize(7);
            doc.setTextColor(100);
            const footerY = 280;
            doc.text('SGS Chile Ltda. Santiago: Puerto Madero #130, Pudahuel | Antofagasta: Av. Pedro Aguirre Cerda #7367 | Concepción: Av. Américo Vespucio #820 | Pto. Varas: Ruta 5 Sur KM 103', 105, footerY, { align: 'center' });
            doc.text('T (56-2) 289 89500, (56-2) 289 89512, (56-55) 223 4098, (56-55) 223 4596, (56-41) 241 6577, (56-65) 232 1800, (56-2) 232 1801. www.sgs.com', 105, footerY + 3, { align: 'center' });
            
            // Descargar
            doc.save(`Acta_PreIngreso_${folio}.pdf`);
        }
        // ===== FIN GENERAR PDF =====


        function confirmarSeleccion() {
            if (!clienteActual) return;
            const tipo = qs('input[name="tipoMuestreo"]:checked').value;
            const checks = qsa('.checkbox-punto:checked:not(:disabled)', modal);
            puntosSeleccionados = [];
            if (tipo === 'filtros') {
                const tf = qs('input[name="tipoFiltro"]:checked').value;
                const arr = (filtrosPorCliente[clienteActual] || {})[tf] || [];
                checks.forEach(ch => {
                    const i = parseInt(ch.dataset.index, 10), f = arr[i];
                    puntosSeleccionados.push({ ...f, tipo: 'filtro', tipoFiltro: tf, lugarMuestreo: '', fechaInicio: '', horaInicio: '', fechaTermino: '', horaTermino: '' })
                });
            } else {
                const arr = puntosMuestreoPorCliente[clienteActual] || [];
                checks.forEach(ch => {
                    const i = parseInt(ch.dataset.index, 10), p = arr[i];
                    puntosSeleccionados.push({ ...p, tipo: 'mps', fechaInicio: '', horaInicio: '', fechaTermino: '', horaTermino: '' })
                });
            }
            actualizarTablaPuntos();
            cerrarModalPuntos();
        }

        // --- Validaciones fecha/horas ---
        function validarRangoFechas(fi, hi, ft, ht) {
            if (!fi || !ft) return { ok: true };
            const s = new Date(`${fi}T${hi || '00:00'}`), e = new Date(`${ft}T${ht || '00:00'}`);
            return { ok: e >= s, start: s, end: e }
        }

        function onActualizarFecha(index, tipo, campo, valor) {
            const p = puntosSeleccionados[index]; p[campo] = valor;
            if (campo === 'fechaInicio') { p.fechaTermino = valor; actualizarTablaPuntos() }
            const { ok, start, end } = validarRangoFechas(p.fechaInicio, p.horaInicio, p.fechaTermino, p.horaTermino);
            if (!ok) {
                alert('La fecha y hora de término no puede ser menor a la fecha y hora de inicio del muestreo');
                if (campo === 'fechaTermino') p.fechaTermino = p.fechaInicio;
                else if (campo === 'horaTermino') p.horaTermino = '';
                actualizarTablaPuntos(); return;
            }
            if (tipo === 'filtro') {
                if (campo === 'fechaInicio') {
                    const fc = new Date(p.fechaCreacion), fi = new Date(valor), dias = Math.floor((fi - fc) / 86400000);
                    if (dias > 30) alert(`⚠ ALERTA: La vida útil del filtro ${p.id} excede los 30 días.
Días desde pre-pesado: ${dias} días
Filtro creado: ${p.fechaCreacion}
Inicio de muestreo: ${valor}`);
                }
                if (p.horaTermino && end) {
                    const horas = (new Date() - end) / 3600000;
                    if (horas > 96) alert(`⚠ ALERTA: Han transcurrido más de 96 horas desde el término del muestreo para el filtro ${p.id}.
Horas transcurridas: ${Math.floor(horas)} horas`);
                }
            }
        }

        // --- Resumen (inyecta dentro de .content) ---
        function mostrarResumen() {
            // Ocultar cards del formulario y título principal
            qsa('.content .card').forEach(c => c.style.display = 'none');
            const h1 = qs('.content h1'); if (h1) h1.style.display = 'none';

            const folio = sessionStorage.getItem('folioPreIngreso');
            const datos = JSON.parse(sessionStorage.getItem('datosPreIngreso'));
            const info = clientesData[datos.cliente];
            const fAhora = new Date().toLocaleString('es-CL');
            const fHoy = new Date().toLocaleDateString('es-CL');
            const [k, i] = datos.ol.split('-');
            const olCodigo = info.ols[parseInt(i, 10)].codigo;

            const filas = datos.puntosSeleccionados.map((p, idx) => {
                const ini = p.fechaInicio && p.horaInicio ? `${p.fechaInicio} ${p.horaInicio}` : p.fechaInicio || '';
                const fin = p.fechaTermino && p.horaTermino ? `${p.fechaTermino} ${p.horaTermino}` : p.fechaTermino || '';
                const lugar = p.tipo === 'filtro'
                    ? (p.lugarMuestreo || '')
                    : `<div style="font-weight:500;">${p.lugar}</div><div style="font-size:11px;color:#666;">${p.direccion}</div>`;
                const det = p.tipo === 'filtro'
                    ? `<div style="font-size:11px;color:#666;">Filtro ${p.tipoFiltro.toUpperCase()} - Creado: ${p.fechaCreacion}</div>`
                    : '';
                const comentario = p.comentario && p.comentario.trim() ? p.comentario : '<span style="color:#999;font-style:italic">Sin comentario</span>';
                return `<tr>
              <td style="text-align:center;font-weight:bold;">${idx + 1}</td>
              <td>${p.id}${det}</td>
              <td>${lugar}</td>
              <td>${ini}</td>
              <td>${fin}</td>
              <td style="max-width: 300px; word-wrap: break-word;">${comentario}</td>
            </tr>`;
            }).join('');

            const html = `
          <div class="resumen-container" id="resumen" class="active">
            <div class="resumen-header" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <div style="display:flex;align-items:center;gap:10px">
                <i class="fas fa-wind" style="background:#ef8157;color:#fff;width:35px;height:35px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px"></i>
                <span style="font-size:16px;color:#666">Ficha de Monitoreo</span>
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button id="btnVolverFormulario" class="btn-volver"><i class="fas fa-arrow-left"></i> Volver al Formulario</button>
              </div>
            </div>

            <div class="card"><div class="card-content">
              <h2 style="color:#ef8157;font-size:20px;margin-bottom:0"># Folio ${folio}</h2>
            </div></div>

            <div class="card"><div class="card-content">
              <h5>Información general del cliente</h5>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label>Cliente</label>
                  <div class="info-value">${info.rut} - ${info.nombre}</div>
                </div>
                <div class="col-md-6">
                  <label>OL</label>
                  <div class="info-value">${olCodigo}</div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-12">
                  <label>Proyecto</label>
                  <div class="info-value">${datos.proyecto || 'Default project'}</div>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-4"><label>Solicitado por:</label><div class="info-value">${datos.solicitadoPor}</div></div>
                <div class="col-md-4"><label>Atención a:</label><div class="info-value">${datos.atencionA}</div></div>
                <div class="col-md-4"><label>ADC Responsable:</label><div class="info-value">${datos.adcResponsable}</div></div>
              </div>
            </div></div>

            <div class="card"><div class="card-content">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h5 class="mb-0">Información general</h5>
                <div style="display:flex;align-items:center;gap:15px">
                  <span class="badge-ingresado">INGRESADO</span>
                  <span style="font-size:14px;color:#666">Fecha: ${fHoy}</span>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label>Tipo Muestreo</label>
                  <div class="info-value">${datos.tipoMuestreo === 'mps' ? 'MPS' : 'Filtros'}</div>
                </div>
                ${datos.tipoMuestreo === 'filtros' && datos.tipoFiltro ? `
                <div class="col-md-6">
                  <label>Tipo de Filtro</label>
                  <div class="info-value">${datos.tipoFiltro.toUpperCase()}</div>
                </div>`: '<div class="col-md-6"></div>'}
              </div>
              <div class="row mb-3">
                <div class="col-md-6"><label>Muestreado por:</label><div class="info-value">${datos.muestreadoPor === 'sgs' ? 'SGS Chile' : 'Cliente'}</div></div>
                <div class="col-md-6"><label>Matriz</label><div class="info-value">${datos.matriz}</div></div>
              </div>
              <div class="row mb-3">
                <div class="col-md-12"><label>Plan</label><div class="info-value">${datos.plan}</div></div>
              </div>
              <div class="row">
                <div class="col-md-12"><label>Generación de JOB</label>
                  <div class="info-value">${datos.generacionJob === 'total'
                    ? 'Generar un JOB para la totalidad de los puntos ingresados'
                    : 'Generar un JOB por punto ingresado'}</div>
                </div>
              </div>
            </div></div>

            <div class="card"><div class="card-content">
              <h5>Puntos de Muestreo</h5>
              <div class="table-responsive mb-3">
                <table class="table">
                  <thead>
                    <tr><th style="width:50px">#</th><th>ID MUESTRA</th><th>LUGAR DE MUESTREO</th><th>FECHA/HORA INICIO</th><th>FECHA/HORA TÉRMINO</th><th>COMENTARIOS</th></tr>
                  </thead>
                  <tbody>${filas}</tbody>
                </table>
              </div>
              <div class="row mb-3">
                <div class="col-md-12"><strong>Cantidad de muestras ingresadas: ${datos.puntosSeleccionados.length}</strong></div>
              </div>
              <div class="row mb-3">
                <div class="col-md-4"><label>Responsable de Muestreo</label><div class="info-value">${datos.responsable}</div></div>
                <div class="col-md-4"><label>Fecha Transporte</label><div class="info-value">${datos.fechaTransporte}</div></div>
                <div class="col-md-4"><label>Hora Transporte</label><div class="info-value">${datos.horaTransporte}</div></div>
              </div>
              <div class="row">
                <div class="col-md-12"><label>Observaciones de terreno</label><div class="info-value">${datos.observaciones}</div></div>
              </div>
            </div></div>

            <div class="card"><div class="card-content">
              <div class="timeline-badge">TIME LINE</div>
              <div class="timeline">
                <div class="timeline-item">
                  <div class="timeline-icon pre-ingreso"><i class="fas fa-file-alt"></i></div>
                  <div class="timeline-card">
                    <div class="timeline-card-header">PRE-INGRESO</div>
                    <div class="timeline-card-body">
                      <p><strong>Fecha:</strong> ${fAhora}</p>
                      <p><strong>Usuario:</strong> ${datos.solicitadoPor}</p>
                      <p><strong>Obser.:</strong> ${datos.observaciones}</p>
                      <a href="#" class="link-descarga" id="btnDescargarActa"><i class="fas fa-download"></i> DESCARGAR ACTA DE PRE-INGRESO</a>
                    </div>
                  </div>
                </div>

                <div class="timeline-item">
                  <div class="timeline-icon recepcion"><i class="fas fa-box"></i></div>
                  <div class="timeline-card">
                    <div class="timeline-card-header">RECEPCIÓN</div>
                    <div class="timeline-card-body">
                      <p><strong>Fecha:</strong> ${fAhora}</p>
                      <a href="#" class="link-descarga"><i class="fas fa-download"></i> DESCARGAR CADENA DE CUSTODIA</a>
                    </div>
                  </div>
                </div>
              </div>
            </div></div>

            <div style="text-align:center;margin:30px 0;color:#999;font-size:12px">SGS</div>
          </div>`;

            const container = qs('.content');
            container.insertAdjacentHTML('beforeend', html);
            // Mostrar el contenedor de resumen (queda al final)
            const resumenEl = qs('#resumen');
            if (resumenEl) { resumenEl.classList.add('active'); }
            // Acción volver
            qs('#btnVolverFormulario').addEventListener('click', () => location.reload());
            // Acción descargar acta
            qs('#btnDescargarActa').addEventListener('click', (e) => {
                e.preventDefault();
                generarPDFActa();
            });
        }

        // --- Enviar / guardar y mostrar resumen ---
        function enviar() {
            if (!puntosSeleccionados.length) return alert('Por favor, seleccione al menos un punto de muestreo antes de enviar.');
            const cliente = qs('#selectCliente').value, ol = qs('#selectOL').value;
            if (!cliente || !ol) return alert('Por favor, complete todos los campos requeridos (Cliente y OL).');
            if (!confirm('¿Está seguro que desea enviar el Pre-Ingreso de Aire?')) return;

            // Generar folio
            const folio = Math.floor(Math.random() * 900000) + 100000;

            // Tipo & filtro
            const tipo = qs('input[name="tipoMuestreo"]:checked').value;
            const rf = qs('input[name="tipoFiltro"]:checked');
            const tipoFiltro = (tipo === 'filtros' && rf) ? rf.value : null;

            // Guardar
            sessionStorage.setItem('folioPreIngreso', folio);
            sessionStorage.setItem('datosPreIngreso', JSON.stringify({
                cliente, ol,
                puntosSeleccionados,
                tipoMuestreo: tipo,
                tipoFiltro,
                matriz: qs('#matriz').value,
                muestreadoPor: qs('input[name="muestreadoPor"]:checked').value,
                plan: qs('#planesText').textContent,
                responsable: qs('#responsableMuestreo').value || 'N/A',
                fechaTransporte: qs('#fechaTransporte').value,
                horaTransporte: qs('#horaTransporte').value,
                observaciones: qs('#observacionesTerreno').value || 'N/A',
                generacionJob: qs('input[name="job"]:checked').value,
                proyecto: qs('#selectProyecto').value,
                solicitadoPor: qs('#solicitadoPor').value,
                atencionA: qs('#atencionA').value,
                adcResponsable: qs('#adcResponsable').value
            }));

            // Mostrar resumen
            mostrarResumen();
        }

        // --- Listeners principales ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar variables del modal de comentarios
            modalComentario = qs('#modalComentario');
            textareaComentario = qs('#textareaComentario');

            // Navbar & sidebar
            qs('#btnMenu').addEventListener('click', () => qs('#sidebar').classList.toggle('show'));
            qs('#btnBack').addEventListener('click', () => { window.location.href = 'sgs-sistema-simplificado.html#ingresos-aire'; });
            qs('#btnSalir').addEventListener('click', e => { e.preventDefault(); alert('Cerrando sesión...') });

            // Matriz por defecto
            const selMat = qs('#matriz');
            selMat.innerHTML = '<option value="POLVO_SEDIMENTABLE" selected>POLVO_SEDIMENTABLE</option>';

            // Cliente -> OL
            qs('#selectCliente').addEventListener('change', e => {
                const key = e.target.value, selOL = qs('#selectOL'), info = qs('#infoAdicional');
                selOL.innerHTML = '<option value="">Seleccione una OL</option>';
                setVisible(info, false);
                clienteActual = key;
                puntosSeleccionados = [];
                actualizarTablaPuntos();
                if (!key) return;
                clientesData[key].ols.forEach((ol, i) => {
                    const o = document.createElement('option');
                    o.value = `${key}-${i}`;
                    o.textContent = ol.codigo;
                    selOL.appendChild(o);
                });
            });

            // OL seleccionada -> proyectos + datos contacto
            qs('#selectOL').addEventListener('change', e => {
                const v = e.target.value, info = qs('#infoAdicional');
                if (!v) { setVisible(info, false); return; }
                const [k, i] = v.split('-');
                const ol = clientesData[k].ols[parseInt(i, 10)];
                const sp = qs('#selectProyecto');
                sp.innerHTML = '<option value="">Seleccione un proyecto</option>';
                ol.proyectos.forEach(p => {
                    const o = document.createElement('option'); o.value = p; o.textContent = p; sp.appendChild(o);
                });
                qs('#atencionA').value = ol.atencionA;
                qs('#adcResponsable').value = ol.adc;
                setVisible(info, true);
            });

            // Tipo de muestreo
            qsa('input[name="tipoMuestreo"]').forEach(r => r.addEventListener('change', e => {
                const filtros = qs('#opcionesFiltros'), jobTotal = qs('#opcionJobTotal'), jobInd = qs('input[name="job"][value="individual"]');
                puntosSeleccionados = []; actualizarTablaPuntos();
                if (e.target.value === 'filtros') {
                    setVisible(filtros, true); setVisible(jobTotal, true);
                    selMat.innerHTML = '<option value="">Seleccione Matriz</option><option value="AIRE_MP_FILTRO_47MM">AIRE_MP_FILTRO_47MM</option><option value="AIRE_MP_FILTRO_HVOL">AIRE_MP_FILTRO_HVOL</option><option value="AIRE_MP_FILTRO_37MM">AIRE_MP_FILTRO_37MM</option>';
                } else {
                    setVisible(filtros, false); setVisible(jobTotal, false); jobInd.checked = true;
                    selMat.innerHTML = '<option value="POLVO_SEDIMENTABLE" selected>POLVO_SEDIMENTABLE</option>';
                }
            }));

            // Dropdown plan
            qs('#btnPlanesToggle').addEventListener('click', e => {
                e.stopPropagation();
                qs('#planesDropdown').classList.toggle('show');
            });
            qs('#planesDropdown').addEventListener('click', e => {
                const it = e.target.closest('.dropdown-item-custom'); if (!it) return;
                qs('#planesText').textContent = it.dataset.plan;
                qs('#planesDropdown').classList.remove('show');
            });
            qs('#searchPlanes').addEventListener('input', e => {
                const t = e.target.value.toLowerCase();
                qsa('#planesDropdown .dropdown-item-custom').forEach(i => i.style.display = i.textContent.toLowerCase().includes(t) ? 'block' : 'none');
            });
            document.addEventListener('click', e => {
                if (!e.target.closest('.dropdown-custom')) qs('#planesDropdown').classList.remove('show')
            });

            // Abrir modal puntos
            qs('#btnBuscarPuntos').addEventListener('click', () => {
                if (!clienteActual) return alert('Por favor, seleccione un cliente primero');
                const tipo = qs('input[name="tipoMuestreo"]:checked').value;
                if (tipo === 'filtros') {
                    const tf = qs('input[name="tipoFiltro"]:checked'); if (!tf) return alert('Por favor, seleccione el tipo de filtro (MP10 o MP2.5) primero');
                    abrirModalFiltros(tf.value);
                } else abrirModalMPS();
            });

            // Modal events
            qs('#btnCerrarModal').addEventListener('click', cerrarModalPuntos);
            qs('#btnCancelarModal').addEventListener('click', cerrarModalPuntos);
            modal.addEventListener('click', e => { if (e.target === modal) cerrarModalPuntos(); });
            document.addEventListener('keydown', e => { if (e.key === 'Escape' && modal.classList.contains('show')) cerrarModalPuntos(); });
            modal.addEventListener('change', e => { if (e.target.id === 'selectAll') qsa('.checkbox-punto:not(:disabled)', modal).forEach(c => c.checked = e.target.checked); });
            qs('#searchPuntos').addEventListener('input', e => {
                const t = e.target.value.toLowerCase();
                qsa('#tablaPuntosModal tr').forEach(r => r.style.display = r.textContent.toLowerCase().includes(t) ? '' : 'none');
            });
            qs('#btnConfirmarSeleccion').addEventListener('click', confirmarSeleccion);

            // Tabla eventos (inputs dinámicos)
            qs('#tablaPuntosSeleccionados').addEventListener('input', e => {
                const t = e.target;
                if (t.matches('[data-remove]')) return;
                const idx = parseInt(t.dataset.idx || '-1', 10), campo = t.dataset.field, tipo = t.dataset.type;
                if (Number.isInteger(idx) && campo) {
                    if (t.type === 'date' || t.type === 'time') onActualizarFecha(idx, tipo, campo, t.value);
                    else puntosSeleccionados[idx][campo] = t.value;
                }
            });
            qs('#tablaPuntosSeleccionados').addEventListener('click', e => {
                const btn = e.target.closest('[data-remove]'); if (btn) eliminarPunto(parseInt(btn.dataset.remove, 10));
            });

            // Enviar
            qs('#btnEnviar').addEventListener('click', enviar);

            // ===== Modal de comentarios - listeners =====
            qs('#btnCerrarComentario').addEventListener('click', cerrarModalComentario);
            qs('#btnCancelarComentario').addEventListener('click', cerrarModalComentario);
            qs('#btnGuardarComentario').addEventListener('click', guardarComentario);
            modalComentario.addEventListener('click', e => { if (e.target === modalComentario) cerrarModalComentario(); });
            document.addEventListener('keydown', e => { if (e.key === 'Escape' && modalComentario.classList.contains('show')) cerrarModalComentario(); });

            // Event listener para botones de comentario en la tabla
            qs('#tablaPuntosSeleccionados').addEventListener('click', e => {
                const btnComment = e.target.closest('[data-comment-idx]');
                if (btnComment) {
                    const idx = parseInt(btnComment.dataset.commentIdx, 10);
                    abrirModalComentario(idx);
                }
            });

            // ===== Modal agregar nuevo punto - listeners =====
            modalAgregarPunto = qs('#modalAgregarPunto');
            qs('#btnCerrarNuevoPunto').addEventListener('click', cerrarModalAgregarPunto);
            qs('#btnCerrarNuevoPunto2').addEventListener('click', cerrarModalAgregarPunto);
            qs('#btnGuardarNuevoPunto').addEventListener('click', guardarNuevoPunto);
            modalAgregarPunto.addEventListener('click', e => { if (e.target === modalAgregarPunto) cerrarModalAgregarPunto(); });
            
            // Event listener para el botón nuevo punto (delegación de eventos)
            document.addEventListener('click', e => {
                if (e.target.id === 'btnNuevoPunto') {
                    abrirModalAgregarPunto();
                }
                if (e.target.id === 'btnMasivo') {
                    abrirModalMasivo();
                }
            });

            // ===== Modal masivo - listeners =====
            modalAgregarMasivo = qs('#modalAgregarMasivo');
            qs('#btnCerrarMasivo').addEventListener('click', cerrarModalMasivo);
            qs('#btnCerrarMasivo2').addEventListener('click', cerrarModalMasivo);
            qs('#btnGuardarMasivo').addEventListener('click', cerrarModalMasivo); // Solo cierra, no hace nada
            modalAgregarMasivo.addEventListener('click', e => { if (e.target === modalAgregarMasivo) cerrarModalMasivo(); });
            // ===== Fin modal agregar nuevo punto =====
            // ===== Fin modal de comentarios =====
        });
    </script>

    <!-- Modal de Comentarios -->
    <div id="modalComentario" class="modal-comentario">
        <div class="modal-dialog-comment">
            <div class="modal-header-comment">
                <h5>Comentario del Punto de Muestreo</h5>
                <button class="close-comment" id="btnCerrarComentario">&times;</button>
            </div>
            <div class="modal-body-comment">
                <label for="textareaComentario">Ingrese su comentario:</label>
                <textarea id="textareaComentario" placeholder="Escriba aquí observaciones o comentarios sobre este punto de muestreo..."></textarea>
            </div>
            <div class="modal-footer-comment">
                <button class="btn-modal-cancel" id="btnCancelarComentario">Cancelar</button>
                <button class="btn-modal-confirm" id="btnGuardarComentario">Guardar Comentario</button>
            </div>
        </div>
    </div>


    <!-- Modal Agregar Nuevo Punto MPS -->
    <div id="modalAgregarPunto" class="modal-agregar-punto">
        <div class="modal-dialog-nuevo">
            <div class="modal-header-nuevo">
                <h5>Agregar punto de muestreo</h5>
                <button class="close-nuevo" id="btnCerrarNuevoPunto">&times;</button>
            </div>
            <div class="modal-body-nuevo">
                <div class="form-group-nuevo">
                    <label>Matriz<span class="required">*</span></label>
                    <select id="matrizNuevoPunto" disabled style="background:#f5f5f5;cursor:not-allowed">
                        <option value="">Seleccione una matriz</option>
                        <option value="Agua Potable/Bebida (A)">Agua Potable/Bebida (A)</option>
                        <option value="POLVO_SEDIMENTABLE">POLVO_SEDIMENTABLE</option>
                        <option value="AIRE_MP_FILTRO_47MM">AIRE_MP_FILTRO_47MM</option>
                        <option value="AIRE_MP_FILTRO_HVOL">AIRE_MP_FILTRO_HVOL</option>
                        <option value="AIRE_MP_FILTRO_37MM">AIRE_MP_FILTRO_37MM</option>
                    </select>
                </div>
                <div class="form-group-nuevo">
                    <label>Lugar de Monitoreo<span class="required">*</span></label>
                    <select id="lugarMonitoreoNuevoPunto">
                        <option value="">Seleccione un lugar</option>
                    </select>
                </div>
                <div class="form-group-nuevo">
                    <label>Nombre del Punto<span class="required">*</span></label>
                    <input type="text" id="nombrePuntoNuevo" placeholder="Ingrese el nombre del punto">
                </div>
                <div class="form-group-nuevo">
                    <label>Dirección de monitoreo<span class="required">*</span></label>
                    <input type="text" id="direccionMonitoreoNuevo" placeholder="Ingrese la dirección">
                </div>
            </div>
            <div class="modal-footer-nuevo">
                <button class="btn-modal-cancel" id="btnCerrarNuevoPunto2">Cerrar</button>
                <button class="btn-modal-confirm" id="btnGuardarNuevoPunto">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Masivo -->
    <div id="modalAgregarMasivo" class="modal-agregar-punto">
        <div class="modal-dialog-nuevo" style="max-width:700px">
            <div class="modal-header-nuevo">
                <h5>Agregar punto de muestreo masivo</h5>
                <button class="close-nuevo" id="btnCerrarMasivo">&times;</button>
            </div>
            <div class="modal-body-nuevo">
                <div class="form-group-nuevo">
                    <label>Matriz<span class="required">*</span></label>
                    <select id="matrizMasivo" disabled style="background:#f5f5f5;cursor:not-allowed">
                        <option value="">Seleccione una matriz</option>
                        <option value="Agua Residual (F)">Agua Residual (F)</option>
                        <option value="Agua Potable/Bebida (A)">Agua Potable/Bebida (A)</option>
                        <option value="POLVO_SEDIMENTABLE">POLVO_SEDIMENTABLE</option>
                        <option value="AIRE_MP_FILTRO_47MM">AIRE_MP_FILTRO_47MM</option>
                        <option value="AIRE_MP_FILTRO_HVOL">AIRE_MP_FILTRO_HVOL</option>
                        <option value="AIRE_MP_FILTRO_37MM">AIRE_MP_FILTRO_37MM</option>
                    </select>
                </div>
                <div class="form-group-nuevo">
                    <label>Lugar de Monitoreo<span class="required">*</span></label>
                    <select id="lugarMonitoreoMasivo">
                        <option value="">Seleccione un lugar</option>
                        <option value="DIVISIÓN DMH">DIVISIÓN DMH</option>
                    </select>
                </div>
                <div class="form-group-nuevo">
                    <label style="margin-bottom:8px">
                        *Pegar aquí la data (CTRL + V)<br>
                        <span style="font-size:11px;color:#666;font-weight:normal">
                            *Considere utilizar este formato para ingresar los registros<br>
                            *Considere la primera fila como cabecera para poder identificar el tipo de dato<br>
                            *Los nombres de la cabecera deben ser iguales al ejemplo para poder ser identificados correctamente.
                        </span>
                    </label>
                    <textarea id="dataMasivo" rows="12" style="font-family:monospace;font-size:12px;width:100%;max-width:650px;resize:vertical" placeholder="|---------------------------|----------------------------|
| PUNTO DE MUESTREO         | FECHA/HORA DE MUESTREO     |
|---------------------------|----------------------------|
| Nombre de Punto           | FORMATO: DD/MM/YYYY HH:MM  |
|---------------------------|----------------------------|"></textarea>
                </div>
            </div>
            <div class="modal-footer-nuevo">
                <button class="btn-modal-cancel" id="btnCerrarMasivo2">Cerrar</button>
                <button class="btn-modal-confirm" id="btnGuardarMasivo">Guardar</button>
            </div>
        </div>
    </div>

</body>
</html>
